<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>GGgifts Admin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background:#0f0f0f; color:#fff; font-family:Arial; padding:15px }
    input, button { width:100%; padding:10px; margin-top:10px }
    .user { padding:10px; border:1px solid #333; margin-top:10px; cursor:pointer }
  </style>
</head>
<body>

<h2>üëë –ê–¥–º–∏–Ω–∫–∞</h2>

<input id="search" placeholder="username –∏–ª–∏ telegram_id">
<button onclick="find()">–ù–∞–π—Ç–∏</button>

<div id="results"></div>
<div id="profile"></div>

<script>
const tg = window.Telegram.WebApp;
const ADMIN_ID = tg.initDataUnsafe.user.id;

async function find() {
  const res = await fetch("/api/admin-search", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ admin_id: ADMIN_ID, query: search.value })
  });
  const data = await res.json();
  results.innerHTML = "";
  data.forEach(u => {
    const d = document.createElement("div");
    d.className = "user";
    d.innerText = `${u.username} (${u.telegram_id}) | ${u.balance} GG‚≠ê`;
    d.onclick = () => openUser(u.telegram_id);
    results.appendChild(d);
  });
}

async function openUser(id) {
  const res = await fetch("/api/admin-user", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ admin_id: ADMIN_ID, user_id: id })
  });
  const data = await res.json();

  profile.innerHTML = `
    <h3>${data.user.username}</h3>
    <p>–ë–∞–ª–∞–Ω—Å: <input id="bal" value="${data.user.balance}"></p>
    <button onclick="setBalance(${id})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
    <button onclick="toggleBan(${id})">
      ${data.user.is_banned ? "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}
    </button>
    <h4>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h4>
    ${data.inventory.map(i =>
      `<div>${i.item_name}
       <button onclick="delItem(${id}, ${i.id})">‚ùå</button></div>`
    ).join("")}
  `;
}

async function setBalance(id) {
  await fetch("/api/admin-user", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      admin_id: ADMIN_ID,
      user_id: id,
      action: "set_balance",
      value: Number(bal.value)
    })
  });
  alert("–ì–æ—Ç–æ–≤–æ");
}

async function toggleBan(id) {
  await fetch("/api/admin-user", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      admin_id: ADMIN_ID,
      user_id: id,
      action: "toggle_ban"
    })
  });
  alert("–ì–æ—Ç–æ–≤–æ");
}
</script>

</body>
</html>
